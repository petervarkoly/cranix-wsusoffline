#
# spec file for package
#
# Copyright (c) 2013 dass IT GmbH, Cologne, Germany.
#
# All modifications and additions to the file contributed by third parties
# remain the property of their copyright owners, unless otherwise agreed
# upon. The license for this file, and modifications and additions to the
# file, is the same license as for the pristine package itself (unless the
# license for the pristine package is not an Open Source License, in which
# case the license is the MIT License). An "Open Source License" is a
# license that conforms to the Open Source Definition (Version 1.9)
# published by the Open Source Initiative.

# Please submit bugfixes or comments via packager@dass-it.de
#
# norootforbuild

Name:           oss-wsusoffline
Group:          System/Management
Version: 	VERSION
Release:        RELEASE
Summary:        WSUS Offline Update: download Microsoft updates
License:        GPLv2+
URL:            http://www.wsusoffline.net/
Source:		%{name}.tar.bz2
Source1: 	wsusoffline90.zip
#Source99:       #{name}-rpmlintrc
BuildRoot:      %{_tmppath}/%{name}-%{version}-build
Requires:	cabextract
Requires:	libmspack
Requires:	lmd
Requires:       md5deep
Requires:       perl-Config-Crontab
Requires:       wget 
Requires:       xmlstarlet
BuildRequires:  unzip

BuildArch:      noarch

%description
"WSUS Offline Update" allows you to download most Microsoft updates and store them localy.
This includes Windows, Office and some extensions like dotnet or Powershell.
After downloading, they can be installed on any Microsoft Windows system without an  Internet connection.
Also unattended/silient installation are possible, so the update be be included easily in a Windows software management system like http://www.opsi.org

%prep
%setup -n %{name}

%build

%install
make DESTDIR=$RPM_BUILD_ROOT install
%define DEST_DIR /srv/itool/wsusoffline/
mkdir -p $RPM_BUILD_ROOT/%{DEST_DIR}/
unzip %{S:1} -d $RPM_BUILD_ROOT/srv/itool/
install -d $RPM_BUILD_ROOT/%{DEST_DIR}/temp/


# remove windows only stuff
rm -r $RPM_BUILD_ROOT/%{DEST_DIR}/*.exe
rm -r $RPM_BUILD_ROOT/%{DEST_DIR}/*.au3
rm -r $RPM_BUILD_ROOT/%{DEST_DIR}/bin
rm -r $RPM_BUILD_ROOT/%{DEST_DIR}/cmd

# adapt permissions
chmod g+ws $RPM_BUILD_ROOT/%{DEST_DIR}
find $RPM_BUILD_ROOT/%{DEST_DIR}/client/ -type d -exec chmod g+ws {} \;
chmod g+ws $RPM_BUILD_ROOT/%{DEST_DIR}/exclude/
chmod g+ws $RPM_BUILD_ROOT/%{DEST_DIR}/log/
chmod g+ws $RPM_BUILD_ROOT/%{DEST_DIR}/iso/
# checkconnection downloads file into this directory
chmod g+ws $RPM_BUILD_ROOT/%{DEST_DIR}/sh/
chmod a+x  $RPM_BUILD_ROOT/%{DEST_DIR}/sh/*
find $RPM_BUILD_ROOT/%{DEST_DIR}/static/ -type d -exec chmod g+ws {} \;
chmod g+ws $RPM_BUILD_ROOT/%{DEST_DIR}/temp/

%clean
rm -rf %{buildroot}

%pre

%post
if [ -e /etc/sysconfig/schoolserver ]; then
   /usr/share/oss/tools/%{name}/wsusUpdate.ldif.sh
fi
exit 0

%files
%defattr(-,root,root)
%dir %{DEST_DIR}
%{DEST_DIR}/doc/
%{DEST_DIR}/xslt/
 
%defattr(-,root,WORKSTATIONS)
%{DEST_DIR}/client/
%{DEST_DIR}/exclude/
%{DEST_DIR}/iso/
%{DEST_DIR}/log/
# write access required, but only for checkconnection
%{DEST_DIR}/sh/
%{DEST_DIR}/static
%{DEST_DIR}/temp/
/usr/share/oss/tools/%{name}/
/usr/share/lmd/alibs/ManageWsusOffline.pm
/srv/itool/swrepository/wpkg/packages/wsusUpdate.xml
%dir /srv/itool
%dir /srv/itool/swrepository
%dir /srv/itool/swrepository/wpkg
%dir /srv/itool/swrepository/wpkg/packages
%dir /usr/share/lmd
%dir /usr/share/lmd/alibs
%dir /usr/share/oss
%dir /usr/share/oss/tools

%changelog
